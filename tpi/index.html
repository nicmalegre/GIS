<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="v6.4.3/css/ol.css" type="text/css">
    <style>
        
    </style>
    <title>G1Maps</title>
    <script src="v6.4.3/build/ol.js" type="text/javascript"></script>
    <script src="url.js" type="text/javascript"></script>

    <!--agregamos la libreria JQuery -->
    <script src="jquery.min.js" type="text/javascript"></script>

    <!-- Importamos el css -->
    <link rel="stylesheet" href="index.css" type="text/css">
    
    <!-- Importamos los iconos de fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>

    <!-- AGREGAR EL NAVBAR -->
    <div class="topnav" id="myTopnav" style="text-align: center;">
        <h1 style="color: #ffff;">GIS - TPI</h1>
        <!-- <a href="#home" class="active">Home</a>
        <a href="#news">News</a>
        <a href="#contact">Contact</a>
        <a href="#about">About</a>
        <a href="javascript:void(0);" class="icon" onclick="myFunction()">
            <i class="fa fa-bars"></i>
        </a> -->
    </div>

    <!-- DIV que contiene el mapa -->
    <div id="map"></div>

    <div id="panel">
        <div id="capas">
            <h3>Capas</h3>
            <!-- checkboxes para activar/desactivar las capas -->
            <input type="checkbox" id="check_layer_1" onclick="mostrarCapa(event)"><label for="check_layer_1"> Actividades Agropecuarias</label><br />
            <input type="checkbox" id="check_layer_2" onclick="mostrarCapa(event)"><label for="check_layer_2"> Actividades Economicas</label><br />
            <input type="checkbox" id="check_layer_3" onclick="mostrarCapa(event)"><label for="check_layer_3"> Complejo de Energia</label><br />
        </div>
    </div>
    <input type="button" id="btn-controlLateralMenu" onclick="controlLateralMenu()" value="Cerrar">
    

    <!-- SCRIPT que crea el mapa y sus capas -->
    <script type="text/javascript">

        var MenuLateralIsOpen = true;


        //creo un source de tipo Vector
        var vectorSource = new ol.source.Vector({
            //formato de los datos a consumir
            format: new ol.format.GeoJSON(),
            //url del archivo o script que genera el GeoJSON
            url: 'espejos_de_agua.geojson'
        });

        //creo una capa de tipo vector
        var vectorLayer = new ol.layer.Vector({
            //asigno el source
            source: vectorSource,
            visible: false,

            //estilo
            style: new ol.style.Style({
                //relleno (solo si hay poligonos)
                fill: new ol.style.Fill({
                    color: 'rgba(255, 204, 51, 0.4)'
                }),
                //trazo (para poligonos y lineas)
                stroke: new ol.style.Stroke({
                    color: '#ffcc33',
                    width: 2
                }),
                //image: para puntos
                image: new ol.style.Circle({
                    radius: 7, //radio en pixeles
                    //relleno
                    fill: new ol.style.Fill({
                        color: '#ffcc33'
                    }),
                    //trazo
                    stroke: new ol.style.Stroke({
                        color: '#000000',
                        width: 1
                    })
                })
            })
        });


        /* Agregamos las capas */
        var actividades_agropecuarias = new ol.layer.Image({
            title: "Actividades Agropecuarias",
            //capa desactivada por defecto
            visible: false,
            source: new ol.source.ImageWMS({
                url: URL_OGC,
                params: {
                    LAYERS: 'actividades_agropecuarias'
                }
            })
        });
        var actividades_economicas = new ol.layer.Image({
            title: "Actividades Economicas",
            //capa desactivada por defecto
            visible: false,
            source: new ol.source.ImageWMS({
                url: URL_OGC,
                params: {
                    LAYERS: 'actividades_economicas'
                }
            })
        });
        var complejo_de_energia_ene = new ol.layer.Image({
            title: "Complejo de Energia",
            //capa desactivada por defecto
            visible: false,
            source: new ol.source.ImageWMS({
                url: URL_OGC,
                params: {
                    LAYERS: 'complejo_de_energia_ene'
                }
            })
        });
        
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    title: "Base Map",
                    source: new ol.source.TileWMS({
                        url: 'http://wms.ign.gob.ar/geoserver/wms',
                        params: {
                            LAYERS: 'capabaseargenmap',
                            VERSION: '1.1.1'
                        }
                    })
                }),
                actividades_agropecuarias,
                actividades_economicas,
                complejo_de_energia_ene,

                //agregi ka caoa vectorial
                vectorLayer

            ],
            view: new ol.View({
                projection: 'EPSG:4326',
                center: [-59, -27.5],
                zoom: 4

            })
        });
    


        //function que va a realizar la peticion de la consulta
        var consultar = function (coordinate) {


            console.log(coordinate);
            if (coordinate.length == 2) {
                //es un punto [lon,lat]
                var wkt = 'POINT(' + coordinate[0] + ' ' + coordinate[1] + ')';
            } else {
                //es un poligono en la forma [ [ [lon,lat],[lon,lat],....] ]
                var wkt = 'POLYGON((';
                for (var i = 0; i < coordinate[0].length - 1; i++) {
                    wkt += coordinate[0][i][0] + ' ' + coordinate[0][i][1] + ',';
                }
                wkt += coordinate[0][0][0] + ' ' + coordinate[0][0][1] + '))'
            }
            console.log(wkt);
            window.open('consulta.php?wkt=' + wkt);
            return;

            // jQuery.ajax({
            //     url:'consulta.php',
            //     method: 'GET',
            //     data:{
            //         wkt:wkt
            //     },
            //     success:function(data){
            //         console.log(data);
            //     }
            // });



        };


        var selectInteraction = new ol.interaction.DragBox({
            condition: ol.events.condition.always, //noModifierKeys
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: [0, 0, 255, 1]
                })
            })
        });


        selectInteraction.on('boxend', function (evt) {
            //this: referencia al selectInteraction
            console.log('boxend', this.getGeometry().getCoordinates());
            consultar(selectInteraction.getGeometry().getCoordinates());

        });

        //funcion para el evento click en el mapa
        var clickEnMapa = function (evt) {
            //muestro por consola las coordenadas del evento
            console.log('click', evt.coordinate);
            consultar(evt.coordinate);
        };



        //function para "cambiar" de interaction en function del value de los radios
        var seleccionarControl = function (el) {
            if (el.value == "consulta") {
                //agrego la interaccion del dragbox
                //la cual tiene precedencia sobre las otras
                map.addInteraction(selectInteraction);

                //subscribo una funcion al evento click del mapa
                map.on('click', clickEnMapa);

            } else if (el.value == "navegacion") {
                //la remuevo...
                map.removeInteraction(selectInteraction);
                //remueveo la subscripcion de la funcion al evento click del mapa
                map.un('click', clickEnMapa);
            }
            //muestro por consola el valor
            console.log(el.value);
        };

        //visibilidad de las capas

        const mostrarCapa = (event) =>{
            var checkbox = document.getElementById(event.target.id);
            console.log(event.target.id)
            console.log(checkbox.checked)

            if (event.target.id === 'check_layer_1'){
                actividades_agropecuarias.setVisible(checkbox.checked)
            }
            if (event.target.id === 'check_layer_2'){
                actividades_economicas.setVisible(checkbox.checked)
            }
            if (event.target.id === 'check_layer_3'){
                complejo_de_energia_ene.setVisible(checkbox.checked)
            }
        }

        const controlLateralMenu = () => {
            const panel = document.getElementById('panel')
            const buttonMenuLateral = document.getElementById('btn-controlLateralMenu')

            if (MenuLateralIsOpen){
                panel.style.display = 'none'
                buttonMenuLateral.value = 'Abrir'
            }else{
                panel.style.display = 'block'
                buttonMenuLateral.value = 'Cerrar'
            }
            MenuLateralIsOpen = !MenuLateralIsOpen
        }
    </script>
</body>

</html>